---
title: "04_DEXSeq"
format: html
---

# DEXSeq

## Load libraries

```{r}
library(DEXSeq)
library(tidyverse)
library(dplyr)
library(tibble)
library(ggplot2)
```

## Metadata preparation

```{r}
# MELANOMA METADATA (usiamo la copia originale salvata in 01_load)
melanoma_metadata <- melanoma_metadata_orig %>%
  dplyr::select(sample = sample_id,
                condition = Groups) %>%
  dplyr::mutate(
    condition = factor(condition,
                       levels = c("untreated", "treated"))
  ) %>%
  as.data.frame()

rownames(melanoma_metadata) <- melanoma_metadata$sample
melanoma_metadata$sample <- NULL

stopifnot(all(rownames(melanoma_metadata) == colnames(melanoma_iso_count)))
```

```{r}
# BLADDER METADATA (usiamo la copia originale salvata in 01_load)
bladder_metadata <- bladder_metadata_orig %>% 
  dplyr::select(sample = sample_id,
                condition = Groups) %>% 
  dplyr::mutate(
    condition = factor(condition,
                       levels = c("untreated", "treated"))
  ) %>% 
  as.data.frame()

rownames(bladder_metadata) <- bladder_metadata$sample
bladder_metadata$sample <- NULL

stopifnot(all(rownames(bladder_metadata) == colnames(bladder_iso_count)))
```

## Transcript–Gene Mapping and Annotation

The code retrieves and aligns **transcript–gene mapping** information, ensuring that the filtered count matrices for **melanoma** and **bladder** samples match the correct **transcript IDs**. It then creates **annotated count tables** by joining the mapping data, adding the corresponding **gene IDs** and **gene names** to each **transcript**.

```{r}
#GETTING ISO INFO
iso_gene_map <- isoInfo %>%
  dplyr::select(
    transcript_id,
    gene_id,
    gene_name
  )
head(iso_gene_map)

# mappa trascritto-gene per MELANOMA (matrice filtrata)
mel_txInfo <- iso_gene_map[match(rownames(melanoma_iso_count_filt),
                                 iso_gene_map$transcript_id), ]
stopifnot(all(mel_txInfo$transcript_id == rownames(melanoma_iso_count_filt)))

# mappa trascritto-gene per BLADDER (matrice filtrata)
blad_txInfo <- iso_gene_map[match(rownames(bladder_iso_count_filt),
                                  iso_gene_map$transcript_id), ]
stopifnot(all(blad_txInfo$transcript_id == rownames(bladder_iso_count_filt)))

#CREATE MELANOMA ASSOCIATIONS
mel_counts_annot <- melanoma_iso_count_filt %>%
  as.data.frame() %>%
  tibble::rownames_to_column("transcript_id") %>%
  dplyr::left_join(iso_gene_map, by = "transcript_id") %>%
  dplyr::relocate(gene_id, gene_name, .before = transcript_id)

head(mel_counts_annot)


#CREATE BLADDER ASSOCIATIONS
blad_counts_annot <- bladder_iso_count_filt %>%
  as.data.frame() %>%
  tibble::rownames_to_column("transcript_id") %>%
  dplyr::left_join(iso_gene_map, by = "transcript_id") %>%
  dplyr::relocate(gene_id, gene_name, .before = transcript_id)

head(blad_counts_annot)
```

## DEXSeq analysis

**Dataset Construction and Differential Exon Usage Testing**: This chunk builds the DEXSeq datasets for melanoma and bladder samples, performs normalization and dispersion estimation, and computes differential exon usage results for each condition.

```{r}
dxd_mel <- DEXSeqDataSet(
  countData = melanoma_iso_count_filt,
  sampleData = melanoma_metadata,
  design = ~ sample + exon + condition:exon,
  featureID = mel_txInfo$transcript_id,
  groupID = mel_txInfo$gene_id
)

dxd_blad <- DEXSeqDataSet(
  countData = bladder_iso_count_filt,
  sampleData = bladder_metadata,
  design = ~ sample + exon + condition:exon,
  featureID = blad_txInfo$transcript_id,
  groupID = blad_txInfo$gene_id
)

dxd_mel  <- estimateSizeFactors(dxd_mel)
dxd_mel  <- estimateDispersions(dxd_mel)
dxd_mel  <- testForDEU(dxd_mel)
dxd_mel  <- estimateExonFoldChanges(dxd_mel, fitExpToVar = "condition")
dexseq_res_melanoma  <- DEXSeqResults(dxd_mel)
  
dxd_blad <- estimateSizeFactors(dxd_blad)
dxd_blad <- estimateDispersions(dxd_blad)
dxd_blad <- testForDEU(dxd_blad)
dxd_blad <- estimateExonFoldChanges(dxd_blad, fitExpToVar = "condition")
dexseq_res_bladder <- DEXSeqResults(dxd_blad)

```

**Convert DEU Results to Data Frames:** This chunk converts the DEXSeq results objects for melanoma and bladder into data frames, preparing them for downstream filtering and significance analysis.

```{r}
## MELANOMA ---- CREATE DATAFRAME AND SORT IT BY ADJUSTED P VALUE
dex_mel_df <- as.data.frame(dexseq_res_melanoma)
## BLADDER ---- CREATE DATAFRAME AND SORT IT BY ADJUSTED P VALUE
dex_blad_df <- as.data.frame(dexseq_res_bladder)
```

**Identify Significant Isoforms and Genes:** This chunk filters DEU results by adjusted p-value to quantify the number of significantly affected isoforms and the corresponding unique genes.

```{r}
alpha <- 0.05

## MELANOMA ----
# Significant isoforms (rows)
sig_iso_mel <- dex_mel_df[!is.na(dex_mel_df$padj) & dex_mel_df$padj < alpha, ]
n_sig_isoforms_mel <- nrow(sig_iso_mel)
n_sig_isoforms_mel

# Significant genes (unique groupID)
n_sig_genes_mel <- length(unique(sig_iso_mel$groupID))
n_sig_genes_mel
```

```{r}
alpha <- 0.05

## BLADDER ----
# Significant isoforms (rows)
sig_iso_blad <- dex_blad_df[!is.na(dex_blad_df$padj) & dex_blad_df$padj < alpha, ]
n_sig_isoforms_blad <- nrow(sig_iso_blad)
n_sig_isoforms_blad

# Significant genes (unique groupID)
n_sig_genes_blad <- length(unique(sig_iso_blad$groupID))
n_sig_genes_blad
```

# Plots

## Volcano plot

```{r}
dex_mel_df <- as.data.frame(dexseq_res_melanoma) %>%
  dplyr::mutate(
    padj_clean = ifelse(is.na(padj), NA,
                        ifelse(padj == 0, .Machine$double.xmin, padj)),
    mlog10padj = -log10(padj_clean),
    log2FC     = dplyr::select(., dplyr::starts_with("log2fold_")) %>% dplyr::pull(),
    is_sig     = !is.na(padj) & padj < 0.05,
    direction  = ifelse(log2FC > 0,
                        "higher in treated",
                        "higher in untreated")
  )

p <- ggplot(dex_mel_df, aes(x = log2FC, y = mlog10padj)) +
  geom_point(aes(color = is_sig, fill = direction),
             shape = 21, alpha = 0.6, size = 1.5, stroke = 0.2) +
  scale_color_manual(values = c("FALSE" = "grey60", "TRUE" = "black"),
                     labels = c("FALSE" = "not significant",
                                "TRUE"  = "padj < 0.05")) +
  scale_fill_manual(values = c("higher in treated"   = "tomato",
                               "higher in untreated" = "skyblue")) +
  geom_hline(yintercept = -log10(0.05), linetype = 2) +
  labs(
    title = "DEXSeq volcano plot – Melanoma",
    x = "log2 fold change (exon usage, treated vs untreated)",
    y = "-log10(adjusted p-value)",
    color = "Significance",
    fill  = "Exon usage"
  ) +
  theme_minimal()
p
ggsave(filename = file.path(plots_dir, "DEXSeq Volcano Plot (Melanoma).png"), plot = p, width = 8, height = 6, dpi = 300)

dex_blad_df <- as.data.frame(dexseq_res_bladder) %>%
  dplyr::mutate(
    padj_clean = ifelse(is.na(padj), NA,
                        ifelse(padj == 0, .Machine$double.xmin, padj)),
    mlog10padj = -log10(padj_clean),
    log2FC     = dplyr::select(., dplyr::starts_with("log2fold_")) %>% dplyr::pull(),
    is_sig     = !is.na(padj) & padj < 0.05,
    direction  = ifelse(log2FC > 0,
                        "higher in treated",
                        "higher in untreated")
  )

p <- ggplot(dex_blad_df, aes(x = log2FC, y = mlog10padj)) +
  geom_point(aes(color = is_sig, fill = direction),
             shape = 21, alpha = 0.6, size = 1.5, stroke = 0.2) +
  scale_color_manual(values = c("FALSE" = "grey60", "TRUE" = "black"),
                     labels = c("FALSE" = "not significant",
                                "TRUE"  = "padj < 0.05")) +
  scale_fill_manual(values = c("higher in treated"   = "tomato",
                               "higher in untreated" = "skyblue")) +
  geom_hline(yintercept = -log10(0.05), linetype = 2) +
  labs(
    title = "DEXSeq volcano plot – Bladder",
    x = "log2 fold change (exon usage, treated vs untreated)",
    y = "-log10(adjusted p-value)",
    color = "Significance",
    fill  = "Exon usage"
  ) +
  theme_minimal()
p
ggsave(filename = file.path(plots_dir, "DEXSeq Volcano Plot (Bladder).png"), plot = p, width = 8, height = 6, dpi = 300)
```

**The melanoma volcano plot** shows distinct clusters of exons whose usage significantly differs between treated and untreated samples. The presence of both positively and negatively shifted events indicates that the drug modulates alternative splicing in a targeted but moderate way, suggesting a selective remodeling of isoform expression associated with the treatment response.

**The bladder volcano plot** displays a much larger number of significantly altered exons, with strong shifts in exon usage between treated and untreated groups. This extensive reorganization of alternative splicing suggests that the drug exerts a far more pronounced impact in bladder tissue, reshaping isoform profiles in a way that may underlie tissue-specific therapeutic responses or resistance mechanisms.

**Comparing the two tissues**, bladder samples show a far more extensive and pronounced shift in exon usage than melanoma, indicating that the drug induces a much stronger and more widespread remodeling of alternative splicing in bladder cancer. This suggests a tissue-specific sensitivity to the treatment, where melanoma exhibits a more selective splicing response while bladder tissue undergoes a broader isoform reprogramming that may influence therapeutic effectiveness or resistance.

## Ma plot

```{r}
### MELANOMA MA-PLOT ----
p <- plotMA(
  dexseq_res_melanoma,
  main = "DEXSeq MA Plot – Melanoma",
  cex = 0.5
)

ggsave(filename = file.path(plots_dir, "DEXSeq MA Plot (Melanoma).png"), plot = p, width = 8, height = 6, dpi = 300)

### BLADDER MA-PLOT ----
p <- plotMA(
  dexseq_res_bladder,
  main = "DEXSeq MA Plot – Bladder",
  cex = 0.5
)

ggsave(filename = file.path(plots_dir, "DEXSeq MA Plot (Bladder).png"), plot = p, width = 8, height = 6, dpi = 300)
```

**In the melanoma MA plot**, almost all the points are concentrated around the horizontal zero line: this indicates that most exons exhibit minimal differences in usage between treated and untreated subjects. Furthermore, the red points, representing exons significantly altered by treatment, are relatively few and distributed narrowly along the vertical axis (log2 fold-change). The lack of large upward or downward deviations (absence of many values ​​\>1 or \<-1) confirms that the drug induces only modest splicing changes. In other words, reading the graph, it is clear that in melanoma, the effect of treatment on splicing is present but limited.

**In the bladder MA plot**, however, a much broader distribution of points along the vertical axis is noted: numerous exons show marked log2 fold changes, both positive and negative. This indicates that exon usage varies more strongly between treated and control subjects. Furthermore, the number of red points is significantly higher than in melanoma: a massive presence of exons with padj \< 0.05 suggests that the treatment significantly influences a much higher number of splicing events. Reading the graph, the width of the dispersion and the high density of significant exons clearly show that the drug has a much more extensive effect on the modulation of isoforms in bladder tissue.

**Comparing the two MA plots** directly, we note that in melanoma, the cloud of dots is narrow and centered around zero with few significant exons, while in the bladder, the vertical dispersion is much wider and the red dots are numerous and distributed across the entire log2 fold-change range. This interpretation of the graph indicates that the drug has a significantly more intense impact on splicing in the bladder, while in melanoma, the effect remains more moderate. Interpretation therefore depends on the amplitude of the change (height of the dots) and the number of significant events (number of red dots).

## Heatmap

```{### HEATMAP – TOP DEU EXONS (MELANOMA)   ###}
# 1. Top 100 esoni significativi
top_mel <- sig_iso_mel %>%
  arrange(padj) %>%
  head(100)

top_ids_mel <- rownames(top_mel)

# 2. Estrarre i fitted values dal modello DEXSeq
fitted_mel <- fitted(dxd_mel) %>%
  as.data.frame() %>%
  tibble::rownames_to_column("exon_id")

# 3. Filtrare i top esoni
heat_mel <- fitted_mel %>%
  filter(exon_id %in% top_ids_mel)

# 4. Convertire in formato long
heat_mel_long <- heat_mel %>%
  tidyr::pivot_longer(
    cols = -exon_id,
    names_to = "sample",
    values_to = "value"
  )

# 5. Aggiungere annotazioni (treated vs untreated)
heat_mel_long <- heat_mel_long %>%
  left_join(
    melanoma_metadata %>% tibble::rownames_to_column("sample"),
    by = "sample"
  )

# 6. Ordinare i campioni per condizione
heat_mel_long$sample <- factor(
  heat_mel_long$sample,
  levels = melanoma_metadata %>%
    tibble::rownames_to_column("sample") %>%
    arrange(condition) %>%
    pull(sample)
)

# 7. Heatmap ggplot2 (migliorata)
ggplot(heat_mel_long, aes(x = sample, y = exon_id, fill = log2(value + 1))) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_blank()
  ) +
  labs(
    title = "Heatmap – Top DEU Exons (Melanoma)",
    x = "Samples",
    y = "Exon bins",
    fill = "log2(fitted+1)"
  )

### HEATMAP – TOP DEU EXONS (BLADDER)    ###
# 1. Top 100 esoni significativi
top_blad <- sig_iso_blad %>%
  arrange(padj) %>%
  head(100)

top_ids_blad <- rownames(top_blad)

# 2. Estrarre i fitted values
fitted_blad <- fitted(dxd_blad) %>%
  as.data.frame() %>%
  tibble::rownames_to_column("exon_id")

# 3. Filtrare i top
heat_blad <- fitted_blad %>%
  filter(exon_id %in% top_ids_blad)

# 4. Long format
heat_blad_long <- heat_blad %>%
  tidyr::pivot_longer(
    cols = -exon_id,
    names_to = "sample",
    values_to = "value"
  )

# 5. Annotazioni (treated/untreated)
heat_blad_long <- heat_blad_long %>%
  left_join(
    bladder_metadata %>% tibble::rownames_to_column("sample"),
    by = "sample"
  )

# 6. Ordinamento dei campioni per condizione
heat_blad_long$sample <- factor(
  heat_blad_long$sample,
  levels = bladder_metadata %>%
    tibble::rownames_to_column("sample") %>%
    arrange(condition) %>%
    pull(sample)
)

# 7. Heatmap
ggplot(heat_blad_long, aes(x = sample, y = exon_id, fill = log2(value + 1))) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    axis.text.y = element_blank()
  ) +
  labs(
    title = "Heatmap – Top DEU Exons (Bladder)",
    x = "Samples",
    y = "Exon bins",
    fill = "log2(fitted+1)"
  )

```
